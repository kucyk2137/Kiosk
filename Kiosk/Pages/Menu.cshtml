@page
@using Kiosk.Models
@using Kiosk.Extensions
@using Microsoft.AspNetCore.Http

@model Kiosk.Pages.MenuModel
<link rel="stylesheet" href="~/css/Layout.css" />
<link rel="stylesheet" href="~/css/popup.css" />
@{
    ViewData["Title"] = "Menu";
    ViewData["PageHeaderTitle"] = "Menu";
    var cartItems = HttpContext.Session.GetObjectFromJson<List<OrderItem>>("Cart") ?? new List<OrderItem>();
    var cartCount = cartItems.Count;
    var isSetCategory = Model.SelectedCategory?.Name?.Equals("Zestawy", StringComparison.OrdinalIgnoreCase) == true;
}

<div class="menu-page">
    <div class="categories">
        @foreach (var category in Model.Categories)
        {
            <form method="get">
                <input type="hidden" name="categoryId" value="@category.Id" />
                <button type="submit" class="category-btn">
                    <img src="@category.Image" alt="@category.Name" class="category-icon" width="25" height="25"/>
                    <span>@category.Name</span>
                </button>
            </form>
        }
        <form method="get" asp-page="/Cart" id="cart-form">
            <button type="button" class="cart-btn" id="cart-btn" data-cart-count="@cartCount">
                Koszyk (@cartCount)
            </button>
        </form>
    </div>

    <div class="products">
        @if (Model.SelectedCategory != null)
        {
            
            <div class="products-grid">
                @foreach (var item in Model.Products)
                {
                    <div class="menu-item">
                        <img src="@item.Image" alt="@item.Name" width="100" />
                        <h3>@item.Name</h3>
                        <p>@item.Description</p>
                        @if (Model.SetContents.ContainsKey(item.Id))
                        {
                            <p class="muted">W zestawie: @string.Join(", ", Model.SetContents[item.Id])</p>
                        }
                        <p>Cena: @item.Price.ToString("0.00") zł</p>

                        <form method="post" class="add-to-cart-form">
                            <input type="hidden" name="menuItemId" value="@item.Id" />
                            <input type="hidden" name="categoryId" value="@Model.SelectedCategory.Id" />
                            <input type="hidden" name="selectedIngredients" value="" />
                            <input type="hidden" name="quantity" value="1" />
                            <button type="button"
                                    class="open-ingredient-modal"
                                    data-menu-item-id="@item.Id"
                                    data-has-set="@Model.ProductsWithSets.Contains(item.Id).ToString().ToLower()"
                                    data-is-set="@isSetCategory.ToString().ToLower()">
                                Dodaj do koszyka
                            </button>
                        </form>
                    </div>                  
                }
            </div>
        }
        else
        {
            <p>Wybierz kategorię, aby zobaczyć produkty.</p>
        }
    </div>
</div>
@if (Model.RecommendedItems.Any())
{
    <div id="recommended-modal" class="modal" style="display:none;">
        <div class="modal-content recommended-modal">
            <div class="recommended-header">
                <p class="eyebrow">Produkty polecane</p>
                <h3>Co powiesz na coś dodatkowego?</h3>
                <p class="muted">Dodaj jedną z naszych propozycji zanim przejdziesz do podsumowania.</p>
            </div>

            <div class="recommended-grid">
                @foreach (var item in Model.RecommendedItems)
                {
                    <div class="recommended-card">
                        <div class="recommended-media">
                            <img src="@item.Image" alt="@item.Name" />
                        </div>
                        <div class="recommended-info">
                            <div class="cell-title">@item.Name</div>
                            <p class="muted">@item.Description</p>
                            <div class="recommended-price">@item.Price.ToString("0.00") zł</div>

                            <form method="post" class="recommended-add-form">
                                <input type="hidden" name="menuItemId" value="@item.Id" />
                                <input type="hidden" name="categoryId" value="@item.CategoryId" />
                                <input type="hidden" name="selectedIngredients" value="[]" />
                                <input type="hidden" name="quantity" value="1" />
                                <button type="submit" class="recommend-add-btn">Dodaj do koszyka</button>
                            </form>
                        </div>
                    </div>
                }
            </div>

            <div class="modal-actions recommended-actions">
                <button type="button" id="recommended-go-to-cart" class="recommend-cart-btn">Przejdź do koszyka</button>
                <button type="button" id="recommended-continue" class="recommend-continue-btn">Kontynuuj zakupy</button>
            </div>
        </div>
    </div>
}
<div id="set-choice-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <h3>Jak dodać produkt?</h3>
        <p class="muted">Możesz dodać pozycję osobno lub wybrać jeden z dostępnych zestawów.</p>
        <div class="modal-actions">
            <button type="button" id="set-without-btn">Bez zestawu</button>
            <button type="button" id="set-with-btn" class="recommend-add-btn">Dodaj w zestawie</button>
        </div>
    </div>
</div>
<div id="set-list-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <h3>Wybierz zestaw</h3>
        <p class="muted">Poniżej pokazujemy tylko zestawy zawierające wybrany produkt.</p>
        <div id="set-list-container" class="recommended-grid"></div>
        <div class="modal-actions">
            <button type="button" id="set-list-close">Zamknij</button>
        </div>
    </div>
</div>
<div id="add-item-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <h3>Dodaj produkt</h3>

        <div class="edit-modal-section">
            <label>Ilość:</label>
            <div class="qty-control">
                <button type="button" id="qty-minus">−</button>
                <span id="qty-value">1</span>
                <button type="button" id="qty-plus">+</button>
            </div>
        </div>
        <div class="edit-modal-section" id="add-default-section">
            <h4>Składniki główne</h4>
            <div id="add-default-ingredients" class="ingredients-list"></div>
        </div>

        <div class="edit-modal-section" id="add-optional-section">
            <h4>Dodatki</h4>
            <div class="addon-counter">Wybrane dodatki: <span id="add-optional-count">0</span></div>
            <div id="add-optional-ingredients" class="ingredients-list"></div>
        </div>

        <div class="modal-actions">
            <button type="button" id="add-cancel">Anuluj</button>
            <button type="button" id="add-confirm">Dodaj do koszyka</button>
        </div>
    </div>
</div>
<script>
    window.kioskInactivityConfig = {
        lockscreenUrl: '@Url.Page("/LockScreen")',
        idleTimeoutMs: 40000,
        promptTimeoutMs: 15000
    };
</script>
<script src="~/js/inactivity.js"></script>
<script src="~/js/recommended.js">
</script>
<script>
        document.addEventListener('DOMContentLoaded', () => {
        const addModal = document.getElementById('add-item-modal');
        const defaultContainer = document.getElementById('add-default-ingredients');
        const optionalContainer = document.getElementById('add-optional-ingredients');
        const defaultSection = document.getElementById('add-default-section');
        const optionalSection = document.getElementById('add-optional-section');
        const qtyMinus = document.getElementById('qty-minus');
        const qtyPlus = document.getElementById('qty-plus');
        const qtyValue = document.getElementById('qty-value');
        const addCancel = document.getElementById('add-cancel');
        const addConfirm = document.getElementById('add-confirm');
        const addOptionalCount = document.getElementById('add-optional-count');

        const setChoiceModal = document.getElementById('set-choice-modal');
        const setWithoutBtn = document.getElementById('set-without-btn');
        const setWithBtn = document.getElementById('set-with-btn');

        const setListModal = document.getElementById('set-list-modal');
        const setListContainer = document.getElementById('set-list-container');
        const setListClose = document.getElementById('set-list-close');

        let optionalSelectedCount = 0;
        let currentForm = null;
        let currentMenuItemId = null;

        function updateOptionalCounter() {
            if (!addOptionalCount) return;
            addOptionalCount.textContent = `${optionalSelectedCount}`;
        }

        function formatLabel(name, price) {
            const numericPrice = Number(price || 0);
            return numericPrice > 0 ? `${name} (+${numericPrice.toFixed(2)} zł)` : name;
        }

        function createChip(name, price, initialCount, maxCount, isOptional = false) {
            const div = document.createElement('div');
            div.classList.add('ingredient-chip');
            div.dataset.name = name;
            div.dataset.price = Number(price || 0);
            const normalizedMax = Math.max(1, maxCount || 1);
            const normalizedInitial = Math.min(Math.max(0, initialCount || 0), normalizedMax);
            div.dataset.count = normalizedInitial;
            div.dataset.max = normalizedMax;

            const label = document.createElement('span');
            label.classList.add('ingredient-name');
            label.textContent = formatLabel(name, price);

            const controls = document.createElement('div');
            controls.classList.add('ingredient-controls');

            const minus = document.createElement('button');
            minus.type = 'button';
            minus.textContent = '−';

            const countDisplay = document.createElement('span');
            countDisplay.classList.add('ingredient-count');

            const plus = document.createElement('button');
            plus.type = 'button';
            plus.textContent = '+';

            const updateDisplay = () => {
                const count = parseInt(div.dataset.count || '0', 10);
                countDisplay.textContent = count;
                div.classList.toggle('selected', count > 0);
            };

            minus.addEventListener('click', () => {
                let count = parseInt(div.dataset.count || '0', 10);
                if (count <= 0) return;

                count -= 1;
                div.dataset.count = count;

                if (isOptional) {
                    optionalSelectedCount -= 1;
                    updateOptionalCounter();
                }

                updateDisplay();
            });

           plus.addEventListener('click', () => {
                let count = parseInt(div.dataset.count || '0', 10);
                const maxAllowed = parseInt(div.dataset.max || '1', 10);

                if (count >= maxAllowed) return;

                count += 1;
                div.dataset.count = count;

                if (isOptional) {
                    optionalSelectedCount += 1;
                    updateOptionalCounter();
                }

                updateDisplay();
            });

            controls.appendChild(minus);
            controls.appendChild(countDisplay);
            controls.appendChild(plus);

            div.appendChild(label);
            div.appendChild(controls);

            if (isOptional) {
                optionalSelectedCount += parseInt(div.dataset.count || '0', 10);
            }

            updateDisplay();

            return div;
        }

        function resetIngredientModal() {
            if (!qtyValue || !defaultContainer || !optionalContainer) return;

            qtyValue.textContent = '1';
            defaultContainer.innerHTML = '';
            optionalContainer.innerHTML = '';
            optionalSelectedCount = 0;
            updateOptionalCounter();
            setSectionVisibility(defaultSection, false);
            setSectionVisibility(optionalSection, false);
        }

        function setSectionVisibility(section, isVisible) {
            if (!section) return;
            section.classList.toggle('is-hidden', !isVisible);
            section.hidden = !isVisible;
            if (isVisible) {
                section.style.removeProperty('display');
            } else {
                section.style.display = 'none';
            }
        }

        function toggleIngredientSections(hasDefaults, hasOptionals) {
            setSectionVisibility(defaultSection, hasDefaults);
            setSectionVisibility(optionalSection, hasOptionals);
        }

        function openIngredientModal() {
            if (!currentForm || !currentMenuItemId || !addModal) return;

            resetIngredientModal();

            fetch(`?handler=Ingredients&menuItemId=${currentMenuItemId}`)
                .then(r => {
                    if (!r.ok) {
                        throw new Error('Nie udało się pobrać składników');
                    }
                    return r.json();
                })
                .then(data => {
                    const defaults = data.defaults || data.Defaults || [];
                    const optionals = data.optionals || data.Optionals || [];

                    const normalize = (item) => {
                        if (typeof item === 'string') {
                            return { name: item, price: 0 };
                        }
                        return {
                            name: item.name || item.Name,
                            price: item.price ?? item.Price ?? item.additionalPrice ?? item.AdditionalPrice ?? 0,
                            quantity: item.quantity ?? item.Quantity ?? 1
                        };
                    };

                    const normalizedDefaults = defaults
                        .map(normalize)
                        .filter(item => item.name && item.name.trim() !== '');
                    const normalizedOptionals = optionals
                        .map(normalize)
                        .filter(item => item.name && item.name.trim() !== '');

                     normalizedDefaults.forEach(({ name, price, quantity }) => {
                        const chip = createChip(name, price, 1, quantity, false);
                        defaultContainer.appendChild(chip);
                    });

                    normalizedOptionals.forEach(({ name, price, quantity }) => {
                        const chip = createChip(name, price, 0, quantity, true);
                        optionalContainer.appendChild(chip);
                    });

                    updateOptionalCounter();
                    toggleIngredientSections(normalizedDefaults.length > 0, normalizedOptionals.length > 0);
                    addModal.style.display = 'flex';
                })
                .catch(err => {
                    console.error(err);
                });
        }

        function renderSetCard(setData) {
            const card = document.createElement('div');
            card.classList.add('recommended-card');

            const media = document.createElement('div');
            media.classList.add('recommended-media');

            const img = document.createElement('img');
            img.src = setData.image;
            img.alt = setData.name;
            media.appendChild(img);

            const info = document.createElement('div');
            info.classList.add('recommended-info');

            const title = document.createElement('div');
            title.classList.add('cell-title');
            title.textContent = setData.name;

            const desc = document.createElement('p');
            desc.classList.add('muted');
            desc.textContent = setData.description || '';

            const itemsList = document.createElement('p');
            itemsList.classList.add('muted');
            const itemNames = (setData.items || []).map(i => i.name).join(', ');
            itemsList.textContent = `Zawiera: ${itemNames}`;

            const price = document.createElement('div');
            price.classList.add('recommended-price');
            price.textContent = `${Number(setData.price || 0).toFixed(2)} zł`;

            const actions = document.createElement('div');
            actions.classList.add('recommended-actions');

            const selectBtn = document.createElement('button');
            selectBtn.type = 'button';
            selectBtn.classList.add('recommend-add-btn');
            selectBtn.textContent = 'Wybierz zestaw';
            selectBtn.addEventListener('click', () => {
                addSetToCart(setData);
            });

            actions.appendChild(selectBtn);

            info.appendChild(title);
            info.appendChild(desc);
            info.appendChild(itemsList);
            info.appendChild(price);
            info.appendChild(actions);

            card.appendChild(media);
            card.appendChild(info);

            return card;
        }

        function addSetToCart(setData) {
            if (!currentForm) return;

            const menuInput = currentForm.querySelector('input[name="menuItemId"]');
            const catInput = currentForm.querySelector('input[name="categoryId"]');
            const ingredientsInput = currentForm.querySelector('input[name="selectedIngredients"]');
            const qtyInput = currentForm.querySelector('input[name="quantity"]');

            if (menuInput) menuInput.value = setData.id;
            if (catInput) catInput.value = setData.categoryId;
            if (ingredientsInput) ingredientsInput.value = '[]';
            if (qtyInput) qtyInput.value = '1';


            currentMenuItemId = setData.id;

            if (setListModal) {
                setListModal.style.display = 'none';
            }


            openIngredientModal();
        }

        function loadSetsForProduct(menuItemId) {
            if (!setListContainer || !setListModal) {

                openIngredientModal();
                return;
            }

            setListContainer.innerHTML = '<p class="muted">Ładowanie zestawów...</p>';

            fetch(`?handler=SetsForProduct&menuItemId=${menuItemId}`)
                .then(r => {
                    if (!r.ok) {
                        throw new Error('Nie udało się pobrać zestawów');
                    }
                    return r.json();
                })
                .then(data => {
                    if (!data || data.length === 0) {

                        setListModal.style.display = 'none';
                        openIngredientModal();
                        return;
                    }

                    setListContainer.innerHTML = '';
                    data.forEach(setData => {
                        setListContainer.appendChild(renderSetCard(setData));
                    });

                    setListModal.style.display = 'flex';
                })
                .catch(err => {
                    console.error(err);
                    setListModal.style.display = 'none';
                    openIngredientModal();
                });
        }



        if (qtyMinus && qtyValue) {
            qtyMinus.addEventListener('click', () => {
                let q = parseInt(qtyValue.textContent || '1', 10);
                if (q > 1) q--;
                qtyValue.textContent = q.toString();
            });
        }

        if (qtyPlus && qtyValue) {
            qtyPlus.addEventListener('click', () => {
                let q = parseInt(qtyValue.textContent || '1', 10);
                q++;
                qtyValue.textContent = q.toString();
            });
        }

        addCancel?.addEventListener('click', () => {
            if (addModal) addModal.style.display = 'none';
            currentForm = null;
            currentMenuItemId = null;
        });

        addConfirm?.addEventListener('click', () => {
            if (!currentForm || !defaultContainer || !optionalContainer || !qtyValue) return;

            const selected = [];

            defaultContainer.querySelectorAll('.ingredient-chip').forEach(chip => {
                const count = parseInt(chip.dataset.count || '0', 10);
                for (let i = 0; i < count; i++) {
                    selected.push(chip.dataset.name);
                }
            });

            optionalContainer.querySelectorAll('.ingredient-chip').forEach(chip => {
                const count = parseInt(chip.dataset.count || '0', 10);
                for (let i = 0; i < count; i++) {
                    selected.push(chip.dataset.name);
                }
            });

            const selectedJson = JSON.stringify(selected);

            const ingredientsInput = currentForm.querySelector('input[name="selectedIngredients"]');
            const qtyInput = currentForm.querySelector('input[name="quantity"]');

            if (ingredientsInput) ingredientsInput.value = selectedJson;
            if (qtyInput) qtyInput.value = parseInt(qtyValue.textContent || '1', 10);

            if (addModal) addModal.style.display = 'none';
            currentForm.submit();
        });



        setWithoutBtn?.addEventListener('click', () => {
            if (setChoiceModal) setChoiceModal.style.display = 'none';
            openIngredientModal();
        });

        setWithBtn?.addEventListener('click', () => {
            if (setChoiceModal) setChoiceModal.style.display = 'none';
            loadSetsForProduct(currentMenuItemId);
        });

        setListClose?.addEventListener('click', () => {
            if (setListModal) setListModal.style.display = 'none';
        });

        setChoiceModal?.addEventListener('click', (event) => {
            if (event.target === setChoiceModal) {
                setChoiceModal.style.display = 'none';
            }
        });

        setListModal?.addEventListener('click', (event) => {
            if (event.target === setListModal) {
                setListModal.style.display = 'none';
            }
        });



        document.querySelectorAll('.open-ingredient-modal').forEach(btn => {
            btn.addEventListener('click', () => {
                currentForm = btn.closest('form');
                currentMenuItemId = btn.dataset.menuItemId;

                const hasSet = (btn.dataset.hasSet || '').toLowerCase() === 'true';
                const isSetItem = (btn.dataset.isSet || '').toLowerCase() === 'true';


                if (isSetItem || !hasSet) {
                    openIngredientModal();
                    return;
                }

                if (setChoiceModal) {
                    setChoiceModal.style.display = 'flex';
                } else {
                    openIngredientModal();
                }
            });
        });
    });

</script>