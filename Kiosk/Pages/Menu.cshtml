@page
@using Kiosk.Models
@using Kiosk.Extensions
@using Microsoft.AspNetCore.Http

@model Kiosk.Pages.MenuModel
<link rel="stylesheet" href="~/css/site.css" />

<div class="menu-page">
    <div class="categories">
        <h3>Kategorie</h3>
        @foreach (var category in Model.Categories)
        {
            <form method="get">
                <input type="hidden" name="categoryId" value="@category.Id" />
                <button type="submit" class="category-btn">@category.Name</button>
            </form>
        }
        <form method="get" asp-page="/Cart">
            <button type="submit" class="cart-btn">
                Koszyk (@(HttpContext.Session.GetObjectFromJson<List<OrderItem>>("Cart")?.Count ?? 0))
            </button>
        </form>
    </div>

    <div class="products">
        @if (Model.SelectedCategory != null)
        {
            <h2>@Model.SelectedCategory.Name</h2>
            <div class="products-grid">
                @foreach (var item in Model.Products)
                {
                    <div class="menu-item">
                        <img src="@item.ImageUrl" alt="@item.Name" width="100" />
                        <h3>@item.Name</h3>
                        <p>@item.Description</p>
                        <p>Cena: @item.Price.ToString("0.00") zł</p>

                        <form method="post" class="add-to-cart-form">
                            <input type="hidden" name="menuItemId" value="@item.Id" />
                            <input type="hidden" name="categoryId" value="@Model.SelectedCategory.Id" />
                            <input type="hidden" name="selectedIngredients" value="" />
                            <input type="hidden" name="quantity" value="1" />
                            <button type="button"
                                    class="open-ingredient-modal"
                                    data-menu-item-id="@item.Id">
                                Dodaj do koszyka
                            </button>
                        </form>
                    </div>
                }
            </div>
        }
        else
        {
            <p>Wybierz kategorię, aby zobaczyć produkty.</p>
        }
    </div>
</div>

<!-- POPUP WYBORU SKŁADNIKÓW (IDENTYCZNY STYL JAK W KOSZYKU) -->
<div id="add-item-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <h3>Dodaj produkt</h3>

        <div class="edit-modal-section">
            <label>Ilość:</label>
            <div class="qty-control">
                <button type="button" id="qty-minus">−</button>
                <span id="qty-value">1</span>
                <button type="button" id="qty-plus">+</button>
            </div>
        </div>

        <div class="edit-modal-section">
            <h4>Składniki główne</h4>
            <div id="add-default-ingredients" class="ingredients-list"></div>
        </div>

        <div class="edit-modal-section">
            <h4>Dodatki</h4>
            <div id="add-optional-ingredients" class="ingredients-list"></div>
        </div>

        <div class="modal-actions">
            <button type="button" id="add-cancel">Anuluj</button>
            <button type="button" id="add-confirm">Dodaj do koszyka</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const addModal = document.getElementById('add-item-modal');
        const defaultContainer = document.getElementById('add-default-ingredients');
        const optionalContainer = document.getElementById('add-optional-ingredients');
        const qtyMinus = document.getElementById('qty-minus');
        const qtyPlus = document.getElementById('qty-plus');
        const qtyValue = document.getElementById('qty-value');
        const addCancel = document.getElementById('add-cancel');
        const addConfirm = document.getElementById('add-confirm');

        let currentForm = null;
        let currentMenuItemId = null;

        function createChip(name, selected) {
            const div = document.createElement('div');
            div.classList.add('ingredient-chip');
            if (selected) div.classList.add('selected');
            div.textContent = name;
            div.dataset.name = name;

            div.addEventListener('click', () => {
                div.classList.toggle('selected');
            });

            return div;
        }

        document.querySelectorAll('.open-ingredient-modal').forEach(btn => {
            btn.addEventListener('click', () => {
                currentForm = btn.closest('form');
                currentMenuItemId = btn.dataset.menuItemId;

                // ilość zawsze startuje od 1 przy dodawaniu
                qtyValue.textContent = '1';

                defaultContainer.innerHTML = '';
                optionalContainer.innerHTML = '';

                fetch(`?handler=Ingredients&menuItemId=${currentMenuItemId}`)
                    .then(r => r.json())
                    .then(data => {
                        const defaults = data.defaults || data.Defaults || [];
                        const optionals = data.optionals || data.Optionals || [];

                        // główne składniki domyślnie zaznaczone
                        defaults.forEach(name => {
                            const chip = createChip(name, true);
                            defaultContainer.appendChild(chip);
                        });

                        // dodatki domyślnie odznaczone
                        optionals.forEach(name => {
                            const chip = createChip(name, false);
                            optionalContainer.appendChild(chip);
                        });

                        addModal.style.display = 'flex';
                    });
            });
        });

        qtyMinus.addEventListener('click', () => {
            let q = parseInt(qtyValue.textContent || "1");
            if (q > 1) q--;
            qtyValue.textContent = q;
        });

        qtyPlus.addEventListener('click', () => {
            let q = parseInt(qtyValue.textContent || "1");
            q++;
            qtyValue.textContent = q;
        });

        addCancel.addEventListener('click', () => {
            addModal.style.display = 'none';
            currentForm = null;
            currentMenuItemId = null;
        });

        addConfirm.addEventListener('click', () => {
            if (!currentForm) return;

            const selected = [];

            defaultContainer.querySelectorAll('.ingredient-chip.selected').forEach(chip => {
                selected.push(chip.dataset.name);
            });

            optionalContainer.querySelectorAll('.ingredient-chip.selected').forEach(chip => {
                selected.push(chip.dataset.name);
            });

            const selectedJson = JSON.stringify(selected);

            currentForm.querySelector('input[name="selectedIngredients"]').value = selectedJson;
            currentForm.querySelector('input[name="quantity"]').value = parseInt(qtyValue.textContent || "1");

            addModal.style.display = 'none';
            currentForm.submit();
        });
    </script>
}
